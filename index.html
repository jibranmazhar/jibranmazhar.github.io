<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PakFit — Diet Planner</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff7a59">
<link rel="icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #0f1724;
    --card: #0b1220;
    --muted: #9aa4b2;
    --accent1: linear-gradient(135deg,#ff7a59 0%,#ffb86b 100%);
    --glass: rgba(255,255,255,0.04);
    --glass-2: rgba(255,255,255,0.03);
    --success: #19c37d;
    --danger: #ff6b6b;
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg: #f7fbff;
      --card: #ffffff;
      --muted: #5b6b7b;
      --glass: rgba(10,10,10,0.03);
      --glass-2: rgba(10,10,10,0.02);
    }
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    background: radial-gradient(1200px 400px at 10% 10%, rgba(255,120,70,0.06), transparent),
                radial-gradient(900px 300px at 90% 90%, rgba(70,130,255,0.04), transparent),
                var(--bg);
    color: #e6eef8;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .app {
    max-width:1100px;
    margin:28px auto;
    padding:20px;
    gap:20px;
    display:grid;
    grid-template-columns: 1fr 360px;
  }

  header {
    grid-column:1 / -1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }

  .brand {
    display:flex;
    gap:12px;
    align-items:center;
  }
  .logo {
    width:56px;height:56px;border-radius:12px;
    background:var(--accent1);
    display:grid;place-items:center;
    font-weight:800;color:white;font-size:20px;
    box-shadow:0 6px 24px rgba(0,0,0,0.35);
  }
  h1{margin:0;font-size:20px;line-height:1}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  .controls {
    display:flex;
    gap:8px;
    align-items:center;
  }
  .btn {
    background:var(--card);
    border:1px solid var(--glass-2);
    color:inherit;padding:8px 12px;border-radius:10px;
    cursor:pointer;font-weight:600;font-size:13px;
  }
  .btn.primary {
    background:var(--accent1);
    color: #091020;border: none;
    box-shadow: 0 6px 20px rgba(255,120,70,0.12);
  }

  main {
    background:transparent;
    border-radius:16px;
    padding:18px;
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .card {
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border-radius:14px;
    padding:14px;
    border:1px solid var(--glass-2);
  }

  .today {
    display:flex;
    gap:12px;
    align-items:center;
  }
  .today .info {flex:1}
  .pill {
    font-size:12px;padding:6px 10px;border-radius:999px;background:var(--glass);color:var(--muted);
    display:inline-block;margin-right:6px;font-weight:600;
  }

  .schedule {
    display:grid;
    grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
    gap:12px;
    margin-top:6px;
  }

  .day {
    padding:12px;border-radius:12px;background:var(--card);
    border:1px solid var(--glass);
    cursor:pointer;
    display:flex;flex-direction:column;gap:8px;
    transition:transform .12s ease, box-shadow .12s ease;
  }
  .day:hover{transform:translateY(-6px); box-shadow:0 12px 30px rgba(2,6,23,0.6)}
  .day .date {font-weight:700}
  .day .meta {color:var(--muted);font-size:13px}
  .day .done {
    margin-top:auto;display:flex;justify-content:space-between;align-items:center;
  }
  .toggle {
    width:40px;height:26px;border-radius:20px;background:var(--glass);position:relative;
    display:inline-block;padding:3px;cursor:pointer;
  }
  .knob {width:20px;height:20px;border-radius:50%;background:white;position:absolute;left:3px;top:3px;transition:left .12s ease, background .12s}
  .toggle.on{background:linear-gradient(90deg,#66e3a6,#18b58a);}
  .toggle.on .knob{left:17px;background:white}

  /* sidebar */
  aside {
    height:calc(100vh - 110px);
    position:sticky;top:20px;
    display:flex;flex-direction:column;gap:12px;
  }
  .stats {display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .stat {
    padding:12px;border-radius:10px;background:var(--card);border:1px solid var(--glass);
    text-align:center;
  }
  .small {font-size:12px;color:var(--muted)}
  .export {display:flex;gap:8px;flex-wrap:wrap}

  /* modal */
  .modal-backdrop {
    position:fixed;inset:0;background:rgba(2,6,23,0.55);display:none;align-items:center;justify-content:center;padding:20px;
  }
  .modal {
    width:100%;max-width:760px;background:var(--card);border-radius:14px;padding:18px;border:1px solid var(--glass-2);
  }
  .meal-list {display:grid;gap:8px}
  .meal-item {padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);}

  footer.smallnote {grid-column:1 / -1;color:var(--muted);font-size:13px;margin-top:18px}

  /* settings modal */
  .settings-backdrop { position:fixed; inset:0; background:rgba(2,6,23,0.6); display:none; align-items:center; justify-content:center; padding:20px; }
  .settings-modal { width:100%; max-width:720px; background:var(--card); border-radius:12px; padding:18px; border:1px solid var(--glass-2); }
  .settings-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .settings-full { grid-column:1 / -1; }

  /* responsive */
  @media (max-width:980px){
    .app{grid-template-columns:1fr; padding:14px}
    aside{position:relative;height:auto;order:2}
    main{order:1}
  }
</style>
</head>
<body>
<div class="app" id="app">

  <header>
    <div class="brand">
      <div class="logo">PK</div>
      <div>
        <h1>PakFit — Diet Planner</h1>
        <p class="lead">6-week plan · simple daily follow-up · offline ready</p>
      </div>
    </div>

    <div class="controls">
      <button class="btn primary" id="installBtn" style="display:none">Install</button>
      <button class="btn" id="openSettingsBtn">Settings</button>
    </div>
  </header>

  <main>
    <section class="card today">
      <div class="info">
        <div style="display:flex;align-items:center;gap:10px;">
          <span class="pill" id="todayDatePill">Today</span>
          <h2 style="margin:0;font-size:18px" id="todayTitle">Day Plan</h2>
        </div>
        <p style="color:var(--muted);margin-top:8px" id="todayDesc">Loading today's plan...</p>
      </div>
      <div style="min-width:180px;text-align:right">
        <div class="small">Follow-up</div>
        <div style="font-weight:700;font-size:20px;margin-top:6px" id="followUpStatus">—</div>
        <div style="margin-top:8px"><button class="btn" id="markTodayDone">Mark Done</button></div>
      </div>
    </section>

    <section>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <h3 style="margin:0">Schedule</h3>
        <div style="color:var(--muted);font-size:13px">Tap any day for details</div>
      </div>

      <div class="schedule card" id="scheduleContainer" aria-live="polite">
        <!-- days injected by JS -->
      </div>
    </section>

    <footer class="smallnote">
      Tip: toggle day completion to track progress. Data saved to your browser only.
    </footer>
  </main>

  <aside>
    <div class="card">
      <h4 style="margin:0 0 10px 0">Progress</h4>
      <div class="stats" id="stats">
        <div class="stat">
          <div style="font-size:18px;font-weight:700" id="doneCount">0</div>
          <div class="small">Days done</div>
        </div>
        <div class="stat">
          <div style="font-size:18px;font-weight:700" id="leftCount">42</div>
          <div class="small">Days left</div>
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="export">
        <button class="btn" id="exportJson">Export JSON</button>
        <button class="btn" id="clearAll">Reset</button>
      </div>
    </div>

    <div class="card">
      <h4 style="margin:0 0 10px 0">Rules & Tips</h4>
      <ul style="margin:0 0 0 18px;color:var(--muted)">
        <li>Hydration: 12–15 glasses/day</li>
        <li>Avoid refined sugar & maida</li>
        <li>Limit olive oil to 4 tbsp</li>
        <li>Exercise daily, pray as needed</li>
      </ul>
    </div>
  </aside>

</div>

<!-- day detail modal -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal" id="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 id="modalTitle">Day detail</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="modalToggleDone">Toggle Done</button>
        <button class="btn" id="modalClose">Close</button>
      </div>
    </div>
    <p id="modalDateDesc" style="color:var(--muted);margin-top:6px"></p>

    <div class="meal-list" id="mealList" style="margin-top:12px"></div>

  </div>
</div>

<!-- settings modal -->
<div class="settings-backdrop" id="settingsBackdrop">
  <div class="settings-modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0">Settings</h3>
      <div><button class="btn" id="settingsClose">Close</button></div>
    </div>

    <div class="settings-grid">
      <div class="settings-full">
        <label>Total Days</label>
        <input type="number" id="settingsTotalDays" min="1" value="42">
      </div>

      <div class="settings-full">
        <label>Default Start Date</label>
        <input type="date" id="settingsStartDate">
      </div>

      <div class="settings-full">
        <label>Meals (edit text for all days)</label>
      </div>

      <div class="settings-full">
        <textarea id="meal_beforeBreakfast" rows="2" style="width:100%;"></textarea>
        <textarea id="meal_breakfast" rows="2" style="width:100%;margin-top:6px"></textarea>
        <textarea id="meal_afterBreakfast" rows="2" style="width:100%;margin-top:6px"></textarea>
        <textarea id="meal_lunch" rows="2" style="width:100%;margin-top:6px"></textarea>
        <textarea id="meal_eveningSnack" rows="2" style="width:100%;margin-top:6px"></textarea>
        <textarea id="meal_dinner" rows="2" style="width:100%;margin-top:6px"></textarea>
        <textarea id="meal_beforeSleep" rows="2" style="width:100%;margin-top:6px"></textarea>
      </div>

      <div class="settings-full" style="display:flex;gap:8px;justify-content:flex-end;">
        <button class="btn" id="settingsResetMeals">Reset Meals</button>
        <button class="btn primary" id="settingsSave">Save Settings</button>
      </div>
    </div>

  </div>
</div>

<script>
// PWA: register service worker and manage install prompt
let deferredPrompt;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'inline-block';
});
installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.style.display = 'none';
});

// Register SW
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').catch(()=>{});
}

// Data keys
const LS_KEY = 'pakfit_original_v1';
const LS_MEALS = 'pakfit_meals_v1';
const LS_SETTINGS = 'pakfit_settings_v1';

const defaultMeals = {
  beforeBreakfast: "1 glass warm water\n2 tbsp isphagol\n1 tbsp chia seed",
  breakfast: "1 roti (50g)\n2-3 egg whites\n7 almonds\nOR 1 date",
  afterBreakfast: "1 apple or seasonal fruit\n1 cup tea",
  lunch: "100-150g chicken\n1 roti (50g)\n1 bowl vegetables",
  eveningSnack: "1 banana or seasonal fruit / 2 dates\nblack coffee or 1 cup tea",
  dinner: "100-150g chicken\n1 roti (50g)\n1 bowl vegetables\n2-4 tbsp yogurt",
  beforeSleep: "1 glass warm milk OR 1 glass warm water\n2 tbsp isphagol\n1 tbsp chia seed"
};

let settings = JSON.parse(localStorage.getItem(LS_SETTINGS) || 'null') || {
  totalDays: 42,
  startDate: (new Date()).toISOString().slice(0,10)
};
let meals = JSON.parse(localStorage.getItem(LS_MEALS) || 'null') || defaultMeals;
let plans = [];

function createPlans(startDateStr, totalDaysCount) {
  const start = new Date(startDateStr);
  plans = [];
  for (let i=0;i<totalDaysCount;i++){
    const d = new Date(start.getTime() + i*24*60*60*1000);
    plans.push({
      id: d.toISOString().slice(0,10),
      friendly: d.toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'}),
      dateIso: d.toISOString().slice(0,10),
      completed: false
    });
  }
  localStorage.setItem(LS_KEY, JSON.stringify(plans));
}

function loadPlans() {
  const saved = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
  if (saved && Array.isArray(saved) && saved.length === settings.totalDays) {
    plans = saved;
  } else {
    createPlans(settings.startDate, settings.totalDays);
  }
}

function savePlans() {
  localStorage.setItem(LS_KEY, JSON.stringify(plans));
  updateStats();
}

function updateStats(){
  document.getElementById('doneCount').textContent = plans.filter(p => p.completed).length;
  document.getElementById('leftCount').textContent = Math.max(0, plans.length - plans.filter(p => p.completed).length);
}

const scheduleContainer = document.getElementById('scheduleContainer');

function renderSchedule(){
  scheduleContainer.innerHTML = '';
  plans.forEach(day => {
    const div = document.createElement('div');
    div.className = 'day';
    if (day.completed) div.classList.add('done');
    div.innerHTML = `
      <div class="date">${day.friendly}</div>
      <div class="meta">${meals.breakfast.split('\n')[0]} · ${meals.lunch.split('\n')[0]}</div>
      <div class="done">
        <div style="font-size:12px;color:var(--muted)">${day.completed ? 'Completed' : 'Pending'}</div>
        <div class="toggle ${day.completed ? 'on' : ''}" data-id="${day.id}">
          <div class="knob"></div>
        </div>
      </div>
    `;
    // open modal on card click (except toggle)
    div.addEventListener('click', (e) => {
      if (e.target.closest('.toggle')) return;
      openModal(day.id);
    });
    // toggle handler
    div.querySelector('.toggle').addEventListener('click', (ev) => {
      ev.stopPropagation();
      day.completed = !day.completed;
      savePlans();
      renderSchedule();
    });
    scheduleContainer.appendChild(div);
  });
  updateStats();
}

function renderToday(){
  const todayIso = (new Date()).toISOString().slice(0,10);
  const today = plans.find(p=>p.dateIso===todayIso) || plans[0];
  document.getElementById('todayDatePill').textContent = today.friendly;
  document.getElementById('todayTitle').textContent = today.friendly;
  const descParts = [
    `${meals.beforeBreakfast.split('\n')[0]}`,
    `${meals.breakfast.split('\n')[0]}`,
    `${meals.dinner.split('\n')[0]}`
  ];
  document.getElementById('todayDesc').textContent = descParts.join(' · ');
  document.getElementById('followUpStatus').textContent = today.completed ? 'Done ✅' : 'Pending';
  document.getElementById('markTodayDone').onclick = () => {
    today.completed = !today.completed;
    savePlans();
    renderSchedule();
    renderToday();
  };
}

// Modal logic
const modalBackdrop = document.getElementById('modalBackdrop');
const modalTitle = document.getElementById('modalTitle');
const modalDateDesc = document.getElementById('modalDateDesc');
const mealList = document.getElementById('mealList');
const modalClose = document.getElementById('modalClose');
const modalToggleDone = document.getElementById('modalToggleDone');
let modalCurrent = null;

function openModal(id){
  const plan = plans.find(p=>p.id===id);
  if(!plan) return;
  modalCurrent = plan;
  modalTitle.textContent = plan.friendly;
  modalDateDesc.textContent = plan.dateIso;
  mealList.innerHTML = '';
  Object.keys(meals).forEach(k => {
    const m = meals[k];
    const el = document.createElement('div');
    el.className = 'meal-item';
    el.innerHTML = `<strong>${k.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase())}</strong>
      <div style="color:var(--muted);margin-top:6px;white-space:pre-wrap">${m}</div>`;
    mealList.appendChild(el);
  });
  modalToggleDone.textContent = plan.completed ? 'Mark Undone' : 'Mark Done';
  modalBackdrop.style.display = 'flex';
}
modalClose.addEventListener('click', ()=> { modalBackdrop.style.display = 'none'; modalCurrent=null; });
modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) modalBackdrop.style.display='none' });
modalToggleDone.addEventListener('click', ()=>{
  if(!modalCurrent) return;
  modalCurrent.completed = !modalCurrent.completed;
  savePlans();
  renderSchedule();
  renderToday();
  modalToggleDone.textContent = modalCurrent.completed ? 'Mark Undone' : 'Mark Done';
});

// Settings modal
const settingsBackdrop = document.getElementById('settingsBackdrop');
const openSettingsBtn = document.getElementById('openSettingsBtn');
const settingsClose = document.getElementById('settingsClose');
const settingsTotalDays = document.getElementById('settingsTotalDays');
const settingsStartDate = document.getElementById('settingsStartDate');

openSettingsBtn.addEventListener('click', () => {
  settingsTotalDays.value = settings.totalDays;
  settingsStartDate.value = settings.startDate;
  // fill meal textareas
  document.getElementById('meal_beforeBreakfast').value = meals.beforeBreakfast;
  document.getElementById('meal_breakfast').value = meals.breakfast;
  document.getElementById('meal_afterBreakfast').value = meals.afterBreakfast;
  document.getElementById('meal_lunch').value = meals.lunch;
  document.getElementById('meal_eveningSnack').value = meals.eveningSnack;
  document.getElementById('meal_dinner').value = meals.dinner;
  document.getElementById('meal_beforeSleep').value = meals.beforeSleep;
  settingsBackdrop.style.display = 'flex';
});
settingsClose.addEventListener('click', ()=> settingsBackdrop.style.display = 'none');

document.getElementById('settingsResetMeals').addEventListener('click', () => {
  if(!confirm('Reset meals to defaults?')) return;
  meals = JSON.parse(JSON.stringify(defaultMeals));
  localStorage.setItem(LS_MEALS, JSON.stringify(meals));
  alert('Meals reset. Click Save to apply.');
});

document.getElementById('settingsSave').addEventListener('click', () => {
  const newTotal = parseInt(settingsTotalDays.value) || 1;
  const newStart = settingsStartDate.value || (new Date()).toISOString().slice(0,10);
  const newMeals = {
    beforeBreakfast: document.getElementById('meal_beforeBreakfast').value,
    breakfast: document.getElementById('meal_breakfast').value,
    afterBreakfast: document.getElementById('meal_afterBreakfast').value,
    lunch: document.getElementById('meal_lunch').value,
    eveningSnack: document.getElementById('meal_eveningSnack').value,
    dinner: document.getElementById('meal_dinner').value,
    beforeSleep: document.getElementById('meal_beforeSleep').value
  };
  settings.totalDays = newTotal;
  settings.startDate = newStart;
  meals = newMeals;
  localStorage.setItem(LS_SETTINGS, JSON.stringify(settings));
  localStorage.setItem(LS_MEALS, JSON.stringify(meals));
  createPlans(settings.startDate, settings.totalDays);
  savePlans();
  renderSchedule();
  renderToday();
  settingsBackdrop.style.display = 'none';
});

// Export & Reset buttons
document.getElementById('exportJson').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify({settings,meals,plans}, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'pakfit_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
document.getElementById('clearAll').addEventListener('click', () => {
  if(!confirm('Reset all progress? This cannot be undone.')) return;
  createPlans(settings.startDate, settings.totalDays);
  savePlans();
  renderSchedule();
  renderToday();
});

// initial load
(function init(){
  const savedSettings = JSON.parse(localStorage.getItem(LS_SETTINGS) || 'null');
  if(savedSettings) settings = savedSettings;
  const savedMeals = JSON.parse(localStorage.getItem(LS_MEALS) || 'null');
  if(savedMeals) meals = savedMeals;
  loadPlans();
  renderSchedule();
  renderToday();
})();

// keyboard close modal
window.addEventListener('keydown', (e)=> { if(e.key === 'Escape'){ document.getElementById('modalBackdrop').style.display='none'; settingsBackdrop.style.display='none'; }});

// keep storage in sync across tabs
window.addEventListener('storage', (e) => {
  if(e.key === LS_KEY || e.key === LS_MEALS || e.key === LS_SETTINGS) {
    const s = JSON.parse(localStorage.getItem(LS_SETTINGS) || 'null');
    if(s) settings = s;
    const m = JSON.parse(localStorage.getItem(LS_MEALS) || 'null');
    if(m) meals = m;
    loadPlans();
    renderSchedule();
    renderToday();
  }
});
</script>
</body>
</html>
