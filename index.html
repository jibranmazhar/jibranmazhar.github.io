<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PakFit — Diet Planner</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ff7a59">
  <link rel="icon" href="icon-192.png">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    :root{
      --bg: #0f1724;
      --card: #0b1220;
      --muted: #9aa4b2;
      --accent: #ff7a59;
    }
    body{ background: var(--bg); color:#e6eef8; }
    .navbar { background: linear-gradient(90deg, #ff7a59, #ffb86b); }
    .brand-badge { width:44px;height:44px;border-radius:12px; background:#ffffff22; display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff; }
    .card { background-color:#0b1220; border:1px solid rgba(255,255,255,0.06); color:#e9f0f8; }
    .list-group-item { background-color:#0b1220; color:#e9f0f8; border-color: rgba(255,255,255,0.08); }
    .text-muted { color:#9fb0c3 !important; }
    .btn-primary { background-color:#ff7a59; border-color:#ff7a59; }
    .btn-outline-light { border-color:#9fb0c3; color:#e9f0f8; }
    .btn-outline-light:hover { background:#e9f0f8; color:#0b1220; }
    .modal-content { background-color:#0b1220; color:#e9f0f8; border:1px solid rgba(255,255,255,0.08); }
    .form-check-input:checked { background-color:#ff7a59; border-color:#ff7a59; }
    a, a:hover { color:#ffb86b; }
  </style>
</head>
<body>
<nav class="navbar navbar-dark mb-3">
  <div class="container-fluid">
    <div class="d-flex align-items-center gap-2">
      <div class="brand-badge">PK</div>
      <span class="navbar-brand mb-0 h1">PakFit — Diet Planner</span>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-outline-light d-none" id="installBtn">Install</button>
      <button class="btn btn-light" id="openSettingsBtn">Settings</button>
    </div>
  </div>
</nav>

<div class="container">
  <div class="row g-3">
    <div class="col-lg-8">
      <!-- Today Card -->
      <div class="card shadow-sm mb-3">
        <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
          <div class="me-md-4">
            <div class="small text-muted mb-1" id="todayDatePill">Today</div>
            <h5 class="card-title mb-2" id="todayTitle">Day Plan</h5>
            <p class="card-text text-muted mb-0" id="todayDesc">Loading...</p>
          </div>
          <div class="text-md-end mt-3 mt-md-0">
            <div class="small text-muted">Follow-up</div>
            <div class="fs-4 fw-bold" id="followUpStatus">—</div>
            <button class="btn btn-primary mt-2" id="markTodayDone">Mark Done</button>
          </div>
        </div>
      </div>

      <!-- Schedule -->
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Schedule</h5>
            <span class="text-muted small">Tap a day for details</span>
          </div>
          <ul class="list-group" id="daysList"></ul>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <!-- Progress -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h5 class="card-title">Progress</h5>
          <div class="row text-center g-2">
            <div class="col-6">
              <div class="fs-3 fw-bold" id="doneCount">0</div>
              <div class="text-muted">Done</div>
            </div>
            <div class="col-6">
              <div class="fs-3 fw-bold"><span id="leftCount">0</span>/<span id="totalDays">0</span></div>
              <div class="text-muted">Left / Total</div>
            </div>
          </div>
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-outline-light w-50" id="exportJson">Export JSON</button>
            <button class="btn btn-danger w-50" id="reset">Reset</button>
          </div>
        </div>
      </div>

      <!-- Rules -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Rules & Tips</h5>
          <ul class="mb-0 text-muted">
            <li>Hydration: 12–15 glasses/day</li>
            <li>Avoid refined sugar & maida</li>
            <li>Limit olive oil to 4 tbsp</li>
            <li>Exercise daily, pray as needed</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Day Detail Modal -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Day detail</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-2" id="modalDateDesc"></p>
        <div id="mealList" class="vstack gap-2"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="modalToggleDone">Toggle Done</button>
        <button class="btn btn-primary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Settings</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label class="form-label">Total Days</label>
            <input type="number" id="totalDaysInput" class="form-control" min="1" value="42">
          </div>
          <div class="col-12 col-md-8">
            <label class="form-label">Default Start Date</label>
            <input type="date" id="startDateInput" class="form-control">
          </div>
          <div class="col-12">
            <label class="form-label">Meals (applies to all days)</label>
            <textarea id="meal_beforeBreakfast" rows="2" class="form-control mb-2"></textarea>
            <textarea id="meal_breakfast" rows="2" class="form-control mb-2"></textarea>
            <textarea id="meal_afterBreakfast" rows="2" class="form-control mb-2"></textarea>
            <textarea id="meal_lunch" rows="2" class="form-control mb-2"></textarea>
            <textarea id="meal_eveningSnack" rows="2" class="form-control mb-2"></textarea>
            <textarea id="meal_dinner" rows="2" class="form-control mb-2"></textarea>
            <textarea id="meal_beforeSleep" rows="2" class="form-control"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-light" id="settingsResetMeals">Reset Meals</button>
        <button class="btn btn-primary" id="saveSettings">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
// PWA install prompt
let deferredPrompt;
const installBtn = $('#installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.removeClass('d-none');
});
installBtn.on('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.addClass('d-none');
});
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').catch(()=>{});
}

// Storage keys
const LS_KEY = 'pakfit_bootstrap_plans_v1';
const LS_MEALS_KEY = 'pakfit_bootstrap_meals_v1';
const LS_SETTINGS_KEY = 'pakfit_bootstrap_settings_v1';

const defaultMeals = {
  beforeBreakfast: '1 glass warm water\n2 tbsp isphagol\n1 tbsp chia seed',
  breakfast: '1 roti (50g)\n2-3 egg whites\n7 almonds OR 1 date',
  afterBreakfast: '1 apple or seasonal fruit\n1 cup tea',
  lunch: '100–150g chicken\n1 roti (50g)\n1 bowl vegetables',
  eveningSnack: '1 banana or 2 dates\nblack coffee or tea',
  dinner: '100–150g chicken\n1 roti (50g)\n1 bowl vegetables\n2–4 tbsp yogurt',
  beforeSleep: '1 glass warm milk OR warm water\n2 tbsp isphagol\n1 tbsp chia seed'
};

let settings = JSON.parse(localStorage.getItem(LS_SETTINGS_KEY) || 'null') || {
  totalDays: 42,
  startDate: new Date().toISOString().slice(0,10)
};
let meals = JSON.parse(localStorage.getItem(LS_MEALS_KEY) || 'null') || {...defaultMeals};
let plans = [];

function createPlans(){
  const start = new Date(settings.startDate);
  plans = [];
  for (let i=0;i<settings.totalDays;i++){
    const d = new Date(start.getTime() + i*86400000);
    plans.push({
      id: d.toISOString().slice(0,10),
      dateIso: d.toISOString().slice(0,10),
      friendly: d.toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'}),
      completed: false
    });
  }
  localStorage.setItem(LS_KEY, JSON.stringify(plans));
}

function loadPlans(){
  const saved = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
  if (saved && Array.isArray(saved) && saved.length === settings.totalDays){
    plans = saved;
  } else {
    createPlans();
  }
}

function savePlans(){
  localStorage.setItem(LS_KEY, JSON.stringify(plans));
  updateStats();
}

function updateStats(){
  const done = plans.filter(p=>p.completed).length;
  $('#doneCount').text(done);
  $('#leftCount').text(Math.max(0, plans.length - done));
  $('#totalDays').text(plans.length);
}

function renderToday(){
  const todayIso = new Date().toISOString().slice(0,10);
  const today = plans.find(p=>p.dateIso===todayIso) || plans[0];
  if (!today) return;
  $('#todayDatePill').text(today.friendly);
  $('#todayTitle').text(today.friendly);
  $('#todayDesc').text([meals.beforeBreakfast.split('\n')[0], meals.breakfast.split('\n')[0], meals.dinner.split('\n')[0]].join(' · '));
  $('#followUpStatus').text(today.completed ? 'Done ✅' : 'Pending');
  $('#markTodayDone').off('click').on('click', function(){
    today.completed = !today.completed;
    savePlans();
    renderSchedule();
    renderToday();
  });
}

function renderSchedule(){
  const $list = $('#daysList').empty();
  plans.forEach(p => {
    const id = p.id;
    const item = $(
      `<li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-semibold">${p.friendly}</div>
          <div class="text-muted small">${meals.breakfast.split('\n')[0]} · ${meals.lunch.split('\n')[0]}</div>
        </div>
        <div class="form-check form-switch m-0">
          <input class="form-check-input" type="checkbox" ${p.completed ? 'checked' : ''} data-id="${id}">
        </div>
      </li>`
    );
    item.on('click', function(e){
      if ($(e.target).is('.form-check-input')) return;
      openDayModal(id);
    });
    item.find('.form-check-input').on('change', function(e){
      const plan = plans.find(x=>x.id === $(this).data('id'));
      if (plan){ plan.completed = this.checked; savePlans(); renderToday(); }
    });
    $list.append(item);
  });
  updateStats();
}

// Day modal
let dayModal;
function openDayModal(id){
  const plan = plans.find(p=>p.id===id);
  if(!plan) return;
  $('#modalTitle').text(plan.friendly);
  $('#modalDateDesc').text(plan.dateIso);
  const $mealList = $('#mealList').empty();
  $.each(meals, function(key, val){
    const title = key.replace(/([A-Z])/g,' $1').replace(/^./, s=>s.toUpperCase());
    $mealList.append(`<div class="p-3 border rounded">${'<strong>'+title+':</strong>'}<div class="text-muted mt-1" style="white-space:pre-wrap">${val}</div></div>`);
  });
  $('#modalToggleDone').off('click').on('click', function(){
    plan.completed = !plan.completed;
    savePlans(); renderSchedule(); renderToday();
  });
  dayModal = dayModal || new bootstrap.Modal(document.getElementById('dayModal'));
  dayModal.show();
}

// Settings modal
const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
$('#openSettingsBtn').on('click', function(){
  $('#totalDaysInput').val(settings.totalDays);
  $('#startDateInput').val(settings.startDate);
  $('#meal_beforeBreakfast').val(meals.beforeBreakfast);
  $('#meal_breakfast').val(meals.breakfast);
  $('#meal_afterBreakfast').val(meals.afterBreakfast);
  $('#meal_lunch').val(meals.lunch);
  $('#meal_eveningSnack').val(meals.eveningSnack);
  $('#meal_dinner').val(meals.dinner);
  $('#meal_beforeSleep').val(meals.beforeSleep);
  settingsModal.show();
});
$('#settingsResetMeals').on('click', function(){
  if (!confirm('Reset meals to defaults?')) return;
  meals = {...defaultMeals};
  localStorage.setItem(LS_MEALS_KEY, JSON.stringify(meals));
  alert('Meals reset. Click Save to apply.');
});
$('#saveSettings').on('click', function(){
  settings.totalDays = parseInt($('#totalDaysInput').val()) || 1;
  settings.startDate = $('#startDateInput').val() || new Date().toISOString().slice(0,10);
  meals = {
    beforeBreakfast: $('#meal_beforeBreakfast').val(),
    breakfast: $('#meal_breakfast').val(),
    afterBreakfast: $('#meal_afterBreakfast').val(),
    lunch: $('#meal_lunch').val(),
    eveningSnack: $('#meal_eveningSnack').val(),
    dinner: $('#meal_dinner').val(),
    beforeSleep: $('#meal_beforeSleep').val()
  };
  localStorage.setItem(LS_SETTINGS_KEY, JSON.stringify(settings));
  localStorage.setItem(LS_MEALS_KEY, JSON.stringify(meals));
  createPlans();
  savePlans();
  renderSchedule();
  renderToday();
  settingsModal.hide();
});

// Export & Reset
$('#exportJson').on('click', function(){
  const data = { settings, meals, plans };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'pakfit_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
$('#reset').on('click', function(){
  if(!confirm('Reset all progress?')) return;
  createPlans(); savePlans(); renderSchedule(); renderToday();
});

// Init
$(function(){
  const s = JSON.parse(localStorage.getItem(LS_SETTINGS_KEY) || 'null');
  if (s) settings = s;
  const m = JSON.parse(localStorage.getItem(LS_MEALS_KEY) || 'null');
  if (m) meals = m;
  loadPlans();
  renderSchedule();
  renderToday();
});
</script>
</body>
</html>
